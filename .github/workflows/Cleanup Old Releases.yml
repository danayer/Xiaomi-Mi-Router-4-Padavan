name: Cleanup Old Releases

on:
  schedule:
    - cron: '0 0 */3 * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Delete old releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          # Ensure we have access to GitHub CLI
          gh auth status || exit 1
          
          echo "Fetching releases for branch: $BRANCH"
          
          # Get all releases for current branch
          if ! releases=$(gh release list --repo "$REPO" --limit 999 | grep "$BRANCH" | awk '{print $1}'); then
            echo "No releases found or error occurred"
            exit 0
          fi
          
          # Count releases
          count=$(echo "$releases" | wc -l)
          echo "Found $count releases"
          
          # If more than 1 release exists, delete all except the newest
          if [ "$count" -gt 1 ]; then
            echo "$releases" | tail -n +2 | while read release; do
              echo "Deleting release: $release"
              gh release delete "$release" --repo "$REPO" -y || echo "Failed to delete $release"
            done
          else
            echo "No old releases to clean up"
          fi
